"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.MboxTransformer = void 0;
var stream_1 = require("stream");
var MboxTransformer = /** @class */ (function (_super) {
    __extends(MboxTransformer, _super);
    function MboxTransformer(opts) {
        var _a, _b, _c, _d, _e, _f;
        var _this = _super.call(this, opts !== null && opts !== void 0 ? opts : {
            readableObjectMode: true,
            writableObjectMode: false,
            encoding: 'binary',
        }) || this;
        _this.opts = opts;
        _this.pageSize = ((_b = (_a = opts === null || opts === void 0 ? void 0 : opts.paginationOption) === null || _a === void 0 ? void 0 : _a.pageSize) !== null && _b !== void 0 ? _b : -1) < 0 ? undefined : (_c = opts === null || opts === void 0 ? void 0 : opts.paginationOption) === null || _c === void 0 ? void 0 : _c.pageSize;
        _this.pageNumber = ((_e = (_d = opts === null || opts === void 0 ? void 0 : opts.paginationOption) === null || _d === void 0 ? void 0 : _d.pageNumber) !== null && _e !== void 0 ? _e : -1) < 0 ? undefined : (_f = opts === null || opts === void 0 ? void 0 : opts.paginationOption) === null || _f === void 0 ? void 0 : _f.pageNumber;
        _this.mails = [];
        _this.remaining = '';
        return _this;
    }
    MboxTransformer.prototype._transform = function (chunk, encoding, callback) {
        var _a;
        var _b, _c;
        var data = "" + this.remaining + chunk.toString();
        this.remaining = '';
        var mails = data.split(/^From /m).filter(function (mail) { return mail.length; }).map(function (mail) {
            return "From " + mail;
        });
        this.remaining = (_b = mails.pop()) !== null && _b !== void 0 ? _b : '';
        (_a = this.mails).push.apply(_a, mails);
        if ((_c = this.opts) === null || _c === void 0 ? void 0 : _c.paginationOption) {
            if (this.mails.length > this.pageSize) {
                this.pageNumber -= 1;
                if (this.pageNumber === 0) {
                    this.emit('data', this.mails.splice(0, this.pageSize));
                    this.emit('close');
                }
                else {
                    this.mails.splice(0, this.pageSize);
                }
            }
        }
        callback();
    };
    ;
    MboxTransformer.prototype._flush = function (callback) {
        var _a;
        if (this.remaining.length) {
            this.mails.push(this.remaining);
            this.remaining = '';
            if ((_a = this.opts) === null || _a === void 0 ? void 0 : _a.paginationOption) {
                this.pageNumber -= 1;
                if (this.pageNumber === 0) {
                    this.emit('data', this.mails.splice(0, this.pageSize));
                }
                else {
                    this.emit('data', null);
                }
            }
            else {
                this.emit('data', this.mails);
            }
            callback();
            this.emit('close');
        }
    };
    return MboxTransformer;
}(stream_1.Transform));
exports.MboxTransformer = MboxTransformer;
exports.default = MboxTransformer;
//# sourceMappingURL=Transform.js.map